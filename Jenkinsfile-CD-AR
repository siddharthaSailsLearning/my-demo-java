pipeline {
  agent {
    docker {
      image 'google/cloud-sdk:slim' 
      args '-u root:root' 
    }
  }

  parameters {
        string(name: 'PROJECT_ID', defaultValue: 'fluted-factor-438905-d2', description: 'GCP Project ID')
        string(name: 'REPO_NAME', defaultValue: 'jenkins-ci-cd-ar', description: 'Artifact Registry Repo Name')
        string(name: 'REPO_LOCATION', defaultValue: 'us-central1', description: 'Artifact Registry Location')
        string(name: 'CLUSTER_NAME', defaultValue: 'jenkins-deploy-cluster', description: 'Cluster Name')
        string(name: 'IMAGE_NAME', defaultValue: 'javaapplication', description: 'Image Name')
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Image Tag')
    }  
    
  environment {
    PROJECT_ID = "${params.PROJECT_ID}"
    REGION = "${params.REPO_LOCATION}"
    CLUSTER = "${params.CLUSTER_NAME}"
    K8S_NAMESPACE = 'default'
    REPO = "${params.REPO_NAME}"
    IMAGE = "${params.IMAGE_NAME}"
    ARTIFACT_REGISTRY_HOST = "${params.REPO_LOCATION}-docker.pkg.dev"
    FULL_IMAGE_NAME = "${ARTIFACT_REGISTRY_HOST}/${PROJECT_ID}/${REPO}/${IMAGE}:${params.IMAGE_TAG}"
    DEPLOY_METHOD = 'kubectl' 
  }

  stages {
    stage('Authenticate & Configure') {
      steps {
        withCredentials([file(credentialsId: 'GCP_SERVICE_ACCOUNT_KEY'	, variable: 'GCP_KEY_FILE')]) {
          sh '''
            set -e pipefail
            echo "Activating service account..."
            gcloud auth activate-service-account --key-file=$GCP_KEY_FILE
            gcloud config set project $PROJECT_ID

            echo "Installing kubectl if missing..."
            if ! command -v kubectl >/dev/null 2>&1; then
              echo "Installing kubectl..."
              apt-get update -qq
              apt-get install -y -qq ca-certificates curl gnupg
              curl -fsSLO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
            fi


            echo "Installing gke-gcloud-auth-plugin (robust method)..."

            # ensure keyrings dir exists and proper permissions
            mkdir -p /etc/apt/keyrings
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg \
              | gpg --batch --yes --dearmor -o /etc/apt/keyrings/google-cloud-cli.gpg


            # Use the keyring in the sources.list entry (avoid using apt-key)
            distro="$(lsb_release -c -s || echo 'bookworm')"
            echo "deb [signed-by=/etc/apt/keyrings/google-cloud-cli.gpg] http://packages.cloud.google.com/apt cloud-sdk-${distro} main" \
              > /etc/apt/sources.list.d/google-cloud-sdk.list

            apt-get update -qq && apt-get install -y -qq google-cloud-sdk-gke-gcloud-auth-plugin || true

            # If apt failed for some reason, try gcloud components installer as a fallback
            if ! command -v gke-gcloud-auth-plugin >/dev/null 2>&1; then
              echo "apt install failed or plugin missing — trying gcloud components install..."
              gcloud components update --quiet || true
              gcloud components install gke-gcloud-auth-plugin --quiet || true
            fi

            # final check
            if ! command -v gke-gcloud-auth-plugin >/dev/null 2>&1; then
              echo "ERROR: gke-gcloud-auth-plugin not found in PATH. Aborting."
              exit 1
            fi

            echo "Getting cluster credentials..."
            gcloud container clusters get-credentials $CLUSTER --region $REGION --project $PROJECT_ID
            echo "Current kubectl context:"
            kubectl config current-context
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          sh """
            echo "Deploying image: $FULL_IMAGE_NAME"
            kubectl -n $K8S_NAMESPACE set image deployment/sample-javaapp sample-javaapp=$FULL_IMAGE_NAME --record

            kubectl -n $K8S_NAMESPACE rollout status deployment/sample-javaapp --timeout=120s
          """
        }
      }
    }

    stage('Post-deploy checks') {
      steps {
        sh """
          echo "Checking pod status..."
          kubectl -n $K8S_NAMESPACE get pods -l app=sample-javaapp -o wide
          echo "Checking service status..."
          kubectl -n $K8S_NAMESPACE get svc sample-javaapp-svc -o wide || true
        """
      }
    }
  }

  post {
    failure {
      echo '❌ Deployment failed — check logs and rollout status.'
    }
    success {
      echo '✅ Deployment successful.'
    }
  }
}
