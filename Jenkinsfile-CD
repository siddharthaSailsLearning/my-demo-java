pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "siddhussoft136/java-app"
    }

    stages {
        stage('Pull Latest Image') {
            steps {
                echo "üì¶ Pulling latest Docker image..."
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh '''
                    set -x
                    echo "$PASS" | docker login -u "$USER" --password-stdin
                    docker pull ${DOCKER_IMAGE}:latest
                    '''
                }
            }
        }

        stage('Test Container') {
            steps {
                echo "üß™ Running temporary test container..."
                sh '''
                set -x
                docker rm -f test-app || true
                docker run -d --name test-app -p 8081:8080 ${DOCKER_IMAGE}:latest
                sleep 15
                curl -f http://localhost:8081/demo/Hello || (echo "Container not responding!" && exit 1)
                docker stop test-app && docker rm test-app
                '''
            }
        }

        stage('Deploy Locally') {
            steps {
                echo "üöÄ Deploying container..."
                sh '''
                set -x
                docker rm -f java-app || true
                docker run -d --name java-app -p 8081:8080 ${DOCKER_IMAGE}:latest
                '''
            }
        }
    }

    post {
        always {
            echo "üîç Cleaning up..."
            sh 'docker ps -a'
        }
        success {
            echo '‚úÖ CD pipeline executed successfully.'
        }
        failure {
            echo '‚ùå CD pipeline failed. Check error logs above.'
        }
    }
}
