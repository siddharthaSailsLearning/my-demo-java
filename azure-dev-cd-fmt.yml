trigger: none

resources:
  pipelines:
    - pipeline: ciPipeline
      source: java-app-ci
      trigger:
        branches:
          include:
            - azure-pipelines-ci

variables:
  - group: ci-pipeline-vars
  - name: IMAGE_TAG
    value: "226"   # or use $[ resources.pipeline.ciPipeline.runID ]
  - name: IMAGE_URI
    value: "$(LOCATION)-docker.pkg.dev/$(PROJECT_ID)/$(REPOSITORY)/$(IMAGE_NAME):$(IMAGE_TAG)"
  - name: K8S_NAMESPACE
    value: "default"

stages:
  - stage: GCP_DEPLOY
    displayName: "Authenticate & Deploy to GKE"
    jobs:
      - job: Deploy
        displayName: "Deploy image $(IMAGE_URI) to GKE"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: DownloadSecureFile@1
            name: DownloadGcpKey
            displayName: "Download GCP Service Account Key"
            inputs:
              secureFile: "$(SERVICE_ACCOUNT_SECUREFILE)"

          - task: Bash@3
            displayName: "Install Google Cloud SDK"
            inputs:
              targetType: "inline"
              script: |
                set -euo pipefail
                if ! command -v gcloud >/dev/null; then
                  echo "Installing gcloud..."
                  sudo apt-get update -y
                  sudo apt-get install -y apt-transport-https ca-certificates gnupg curl lsb-release
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
                  curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  sudo apt-get update -y && sudo apt-get install -y google-cloud-sdk
                fi
                echo "gcloud version: $(gcloud version | head -n1)"

          - task: Bash@3
            displayName: "Authenticate to GCP and Configure Docker"
            inputs:
              targetType: "inline"
              script: |
                set -euo pipefail
                echo "Authenticating service account..."
                gcloud auth activate-service-account --key-file="$(DownloadGcpKey.secureFilePath)"
                gcloud config set project $(PROJECT_ID)
                gcloud auth configure-docker $(LOCATION)-docker.pkg.dev --quiet
                echo "Auth successful for project: $(PROJECT_ID)"

          - task: Bash@3
            displayName: "Get GKE Credentials"
            inputs:
              targetType: "inline"
              script: |
                set -euo pipefail
                echo "Fetching GKE credentials for cluster $(CLUSTER_NAME)..."
                # For regional cluster, use --region (not --zone)
                gcloud container clusters get-credentials $(CLUSTER_NAME) --region $(LOCATION) --project $(PROJECT_ID)
                echo "Available contexts:"
                kubectl config get-contexts
                echo "Current context:"
                kubectl config current-context
                echo "Nodes in cluster:"
                kubectl get nodes

          - task: Bash@3
            displayName: "Deploy Image to GKE"
            inputs:
              targetType: "inline"
              script: |
                set -euo pipefail
                echo "Deploying image: $(IMAGE_URI)"
                kubectl -n $(K8S_NAMESPACE) set image deployment/$(IMAGE_NAME) $(IMAGE_NAME)=$(IMAGE_URI)
                kubectl -n $(K8S_NAMESPACE) rollout status deployment/$(IMAGE_NAME) --timeout=300s
                echo "Deployment completed successfully."

          - task: Bash@3
            displayName: "Post-Deployment Check"
            inputs:
              targetType: "inline"
              script: |
                set -euo pipefail
                echo "Pods in namespace $(K8S_NAMESPACE):"
                kubectl -n $(K8S_NAMESPACE) get pods -o wide
                echo "Services:"
                kubectl -n $(K8S_NAMESPACE) get svc
