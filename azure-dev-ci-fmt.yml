trigger:
  branches:
    include:
      - azure-pipelines-ci

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: ci-pipeline-vars
- name: IMAGE_TAG
  value: '$(Build.BuildId)'

stages:

  - stage: Build_And_Push
    displayName: "Build and Push docker image to GAR"

    jobs:
      - job: BuildPush
        displayName: "Build and Push docker Image"
        timeoutInMinutes: 120
        steps:
          - checkout: self 
            displayName: "Checkout repo"

          - task: DownloadSecureFile@1
            name: DownloadGcpKey
            displayName: "Download GCP service account key (secure file)"
            inputs:
              secureFile: '$(SERVICE_ACCOUNT_SECUREFILE)'

          - task: Bash@3
            name: InstallGcloud
            displayName: "Install Google Cloud SDK (gcloud)"
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                if ! command -v gcloud >/dev/null; then
                  echo "Installing google-cloud-sdk..."
                  sudo apt-get update -y
                  sudo apt-get install -y apt-transport-https ca-certificates gnupg curl lsb-release
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
                  curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  sudo apt-get update -y
                  sudo apt-get install -y google-cloud-sdk
                else
                  echo "gcloud already installed."
                fi
        
          - task: Bash@3
            name: GcloudAuthConfigureDocker
            displayName: "Authenticate service account and configure docker for Artifact Registry"
            inputs:
              targetType: 'inline'
              script: |
                set -euo pipefail
                echo "Using secure file path: $(DownloadGcpKey.secureFilePath)"

                gcloud auth activate-service-account --key-file="$(DownloadGcpKey.secureFilePath)"
                gcloud config set project $(PROJECT_ID)

                gcloud auth configure-docker $(LOCATION)-docker.pkg.dev --quiet

          - task: Docker@2
            displayName: "Build Docker Image"
            inputs: 
              command: build
              repository: '$(LOCATION)-docker.pkg.dev/$(PROJECT_ID)/$(REPOSITORY)/$(IMAGE_NAME)'
              dockerfile: '**/Dockerfile'
              tags: |
                $(IMAGE_TAG)

          - task: Bash@3
            name: SetImageUri
            displayName: "Set IMAGE_URI pipeline variable"
            inputs:
              targetType: 'inline'
              script: |
                IMAGE_URI="$(LOCATION)-docker.pkg.dev/$(PROJECT_ID)/$(REPOSITORY)/$(IMAGE_NAME):$(IMAGE_TAG)"
                echo "##vso[task.setvariable variable=IMAGE_URI;isOutput=true]$IMAGE_URI"
                echo "Built image: $IMAGE_URI"

          - task: Docker@2
            displayName: "Push Docker Image to GAR"
            inputs:
              command: push
              repository: '$(LOCATION)-docker.pkg.dev/$(PROJECT_ID)/$(REPOSITORY)/$(IMAGE_NAME)'
              tags: |
                $(IMAGE_TAG)
          
          - task: DeleteFiles@1
            displayName: "Remove downloaded service account key from agent"
            inputs:
              SourceFolder: '$(Agent.TempDirectory)'
              Contents: |
                $(DownloadGcpKey.secureFilePath)
              removeSourceFolder: false

  - stage: Cleanup
    displayName: "Final Cleanup"
    dependsOn: Build_And_Push
    condition: succeededOrFailed()   
    jobs:
      - job: FinalCleanup
        displayName: "Final cleanup & verification"
        steps:
          - script: |
              echo "IMAGE_URI = $(dependencies.Build_And_Push.outputs['BuildPush.SetImageUri.IMAGE_URI'])"
              echo "Cleanup stage finished."
            displayName: "Show IMAGE_URI (if available)"